#!/usr/bin/env bash

INSTALL_DIR="$HOME"
if [ "$(uname)" == "Darwin" ]; then
    INSTALL_DIR="/usr/local"
fi

mkdir "$INSTALL_DIR/bin/" >> /dev/null 2>&1

if [ -f "$INSTALL_DIR/bin/hoard" ]; then
    echo "We'll be updating the installation of hoard at $INSTALL_DIR/bin/hoard. [ctrl-c to cancel]"
    sleep 2
    rm $INSTALL_DIR/bin/hoard
fi

echo "Updating if necessary..."
cd `dirname "$0"`
git pull 
echo
echo "Performing installation..."

(ln `dirname "$0"`/hoard $INSTALL_DIR/bin/hoard && echo "Installed 'hoard' at $INSTALL_DIR/bin/hoard") || (echo "Installation failure" && exit 1)

if [[ -z "$HOARD_SESSIONS_PATH" ]]; then
    export HOARD_SESSIONS_PATH="$HOME/.hoard_sessions"
fi
if [[ -z "$HOARD_BOOKMARKS_PATH" ]]; then
    export HOARD_BOOKMARKS_PATH="$HOME/.hoard_bookmarks"
fi
touch "$HOARD_SESSIONS_PATH"
touch "$HOARD_BOOKMARKS_PATH"

file=
if [ -f "$HOME/.bashrc" ]; then
    file="$HOME/.bashrc"
elif [ -f "$HOME/.bash_profile" ]; then
    file="$HOME/.bash_profile"
elif [ -f "$HOME/.profile" ]; then
    file="$HOME/.profile"
fi

if [[ -z "$file" ]]; then
    :
    echo "Please add '. hoard' to your .bashrc file or equivalent to use the 'hoard' command directly on every new terminal session."
    echo "Otherwise, you should run the hoard command '. hoard' to use the command 'hoard'."
else
    if [ "$(uname)" == "Darwin" ]; then
        sed -i '' "/\. .*hoard$/g" "$file"
    else 
        sed -i "/\. .*hoard$/g" "$file"
    fi
    echo ". $INSTALL_DIR/bin/hoard" >> "$file"
    echo
    echo "Note that you may need to restart your terminal session"
    echo "or run 'source hoard' in order to use the 'hoard' command immediately."
fi

echo 
echo "Installation complete!"
